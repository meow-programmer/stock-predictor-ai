import pandas as pd
import os

# Base directory of your project (AI_Quant folder)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
# Goes 3 levels up from sentiment/update_sp500list.py to AI_Quant

# Paths
RAW_FILE = os.path.join(BASE_DIR, 'data', 'raw', 'sp500_list.xlsx')
CLEAN_FOLDER = os.path.join(BASE_DIR, 'data', 'cleaned')

# Ensure raw folder exists
os.makedirs(os.path.dirname(RAW_FILE), exist_ok=True)

# Load existing sp500 list
if os.path.exists(RAW_FILE):
    sp500 = pd.read_excel(RAW_FILE)
else:
    print("[!] sp500_list.xlsx not found, creating empty DataFrame")
    sp500 = pd.DataFrame(columns=['Symbol', 'Security', 'GICS Sector', 'GICS Sub-Industry',
                                  'Headquarters Location', 'Date added', 'CIK', 'Founded'])

# Get tickers from cleaned folder
cleaned_files = [os.path.splitext(f)[0] for f in os.listdir(CLEAN_FOLDER) if f.endswith('.xlsx')]

# Add missing tickers from cleaned folder (keeping blank info for new tickers)
for ticker in cleaned_files:
    if ticker not in sp500['Symbol'].values:
        sp500 = pd.concat([sp500, pd.DataFrame({
            'Symbol': [ticker],
            'Security': [None],
            'GICS Sector': [None],
            'GICS Sub-Industry': [None],
            'Headquarters Location': [None],
            'Date added': [None],
            'CIK': [None],
            'Founded': [None]
        })], ignore_index=True)

# Save updated sp500 list
sp500.to_excel(RAW_FILE, index=False)
print(f"[+] sp500_list.xlsx updated. Total tickers now: {len(sp500)}")
